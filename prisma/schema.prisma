// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MEMBER
}

enum SubscriptionTier {
  STARTER
  PRO
  ELITE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  TRIAL
}

enum SignalType {
  BUY
  SELL
}

enum SignalStatus {
  ACTIVE
  CLOSED
  CANCELLED
}

enum SignalResult {
  WIN
  LOSS
  BREAKEVEN
}

enum Timeframe {
  SCALP
  DAY_TRADE
  SWING
}

model User {
  id                    String            @id @default(cuid())
  email                 String            @unique
  name                  String?
  role                  UserRole          @default(MEMBER)
  avatar                String?
  phone                 String?
  
  // Stripe integration
  stripeCustomerId      String?           @unique
  stripeSubscriptionId  String?           @unique
  
  // Social integrations
  telegramUserId        String?           @unique
  discordUserId         String?           @unique
  
  // Subscription details
  subscriptionTier      SubscriptionTier?
  subscriptionStatus    SubscriptionStatus?
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  
  // Timestamps
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  // Relations
  subscription          Subscription?
  memberTrades          MemberTrade[]
  announcements         Announcement[]
  
  @@map("users")
}

model Subscription {
  id                    String            @id @default(cuid())
  userId                String            @unique
  stripeSubscriptionId  String            @unique
  plan                  SubscriptionTier
  status                SubscriptionStatus
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAt              DateTime?
  cancelAtPeriodEnd     Boolean           @default(false)
  
  // Timestamps
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  // Relations
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("subscriptions")
}

model Signal {
  id                    String            @id @default(cuid())
  pair                  String
  type                  SignalType
  entryPrice            Decimal           @db.Decimal(10, 5)
  stopLoss              Decimal           @db.Decimal(10, 5)
  takeProfit1           Decimal           @db.Decimal(10, 5)
  takeProfit2           Decimal?          @db.Decimal(10, 5)
  takeProfit3           Decimal?          @db.Decimal(10, 5)
  riskReward            Decimal           @db.Decimal(5, 2)
  timeframe             Timeframe
  reasoning             String
  chartImageUrl         String?
  
  // Status tracking
  status                SignalStatus      @default(ACTIVE)
  result                SignalResult?
  pipsGained            Int?
  
  // TP/SL hit tracking
  tp1Hit                Boolean           @default(false)
  tp2Hit                Boolean           @default(false)
  tp3Hit                Boolean           @default(false)
  slHit                 Boolean           @default(false)
  breakeven             Boolean           @default(false)
  
  // External message IDs
  telegramMessageId     String?
  discordMessageId      String?
  
  // Timestamps
  postedAt              DateTime          @default(now())
  closedAt              DateTime?
  updatedAt             DateTime          @updatedAt
  
  // Relations
  memberTrades          MemberTrade[]
  
  @@map("signals")
}

model MemberTrade {
  id                    String            @id @default(cuid())
  userId                String
  signalId              String
  entryPrice            Decimal?          @db.Decimal(10, 5)
  exitPrice             Decimal?          @db.Decimal(10, 5)
  result                SignalResult?
  pipsGained            Int?
  notes                 String?
  
  // Timestamps
  followedAt            DateTime          @default(now())
  closedAt              DateTime?
  
  // Relations
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  signal                Signal            @relation(fields: [signalId], references: [id], onDelete: Cascade)
  
  @@unique([userId, signalId])
  @@map("member_trades")
}

model Announcement {
  id                    String            @id @default(cuid())
  title                 String
  content               String
  sentTo                String            @default("all") // all, pro, elite
  sentAt                DateTime?
  createdById           String
  
  // Timestamps
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  // Relations
  createdBy             User              @relation(fields: [createdById], references: [id], onDelete: Cascade)
  
  @@map("announcements")
}

model Setting {
  id                    String            @id @default(cuid())
  key                   String            @unique
  value                 String
  description           String?
  
  // Timestamps
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  @@map("settings")
}

model Performance {
  id                    String            @id @default(cuid())
  userId                String?           // null for admin performance
  totalSignals          Int               @default(0)
  winningSignals        Int               @default(0)
  losingSignals         Int               @default(0)
  breakevenSignals      Int               @default(0)
  totalPips             Int               @default(0)
  winRate               Decimal           @db.Decimal(5, 2)
  profitFactor          Decimal           @db.Decimal(5, 2)
  averageWin            Decimal           @db.Decimal(10, 2)
  averageLoss           Decimal           @db.Decimal(10, 2)
  maxDrawdown           Decimal           @db.Decimal(10, 2)
  currentStreak         Int               @default(0)
  bestTrade             Decimal           @db.Decimal(10, 2)
  worstTrade            Decimal           @db.Decimal(10, 2)
  
  // Timestamps
  calculatedAt          DateTime          @default(now())
  periodStart           DateTime
  periodEnd             DateTime
  
  @@map("performance")
}
